# --- build stage ---
FROM node:22-alpine AS build
WORKDIR /app

# samo što treba za npm ci
COPY package*.json ./
COPY tsconfig*.json ./
# Ako imaš vite.config.* kopiraj i to:
COPY vite.config.* ./

# instalacije
RUN npm ci

# kopiraj ostatak koda (ignorisaćemo server i ostalo kroz .dockerignore)
COPY . .

# build
RUN npm run build

# --- runtime stage (nginx) ---
FROM nginx:alpine
# prebaci izgrađenu aplikaciju
COPY --from=build /app/dist /usr/share/nginx/html
# naš nginx config
COPY docker/nginx/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

HEALTHCHECK --interval=10s --timeout=3s --retries=10 \
  CMD wget -qO- http://localhost/ | grep -q '<!DOCTYPE html>' || exit 1
